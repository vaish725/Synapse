<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Integration Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-card {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #4f46e5;
    }
    .output {
      background: #f9fafb;
      padding: 15px;
      margin-top: 10px;
      border-radius: 6px;
      border-left: 3px solid #6366f1;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .error { border-left-color: #ef4444; color: #dc2626; }
    .success { border-left-color: #10b981; color: #059669; }
    h1 { color: #111827; }
    h2 { color: #374151; font-size: 18px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>🧠 AI Integration Test Page</h1>
  <p>This page tests the Gemini Nano integration independently of the popup.</p>

  <!-- Test 1: Check if functions are loaded -->
  <div class="test-card">
    <h2>Test 1: Check if AI functions are loaded</h2>
    <button onclick="testFunctionsLoaded()">Run Test</button>
    <div id="test1-output" class="output"></div>
  </div>

  <!-- Test 2: Check Gemini Nano availability -->
  <div class="test-card">
    <h2>Test 2: Check Gemini Nano Availability</h2>
    <button onclick="testAvailability()">Check Availability</button>
    <div id="test2-output" class="output"></div>
  </div>

  <!-- Test 3: Generate test insight -->
  <div class="test-card">
    <h2>Test 3: Generate Test Insight</h2>
    <button onclick="testInsightGeneration()">Generate Insight</button>
    <div id="test3-output" class="output"></div>
  </div>

  <!-- Test 4: Test with sample data -->
  <div class="test-card">
    <h2>Test 4: Full Integration Test</h2>
    <button onclick="testFullIntegration()">Run Full Test</button>
    <div id="test4-output" class="output"></div>
  </div>

  <!-- Console log viewer -->
  <div class="test-card">
    <h2>Console Logs</h2>
    <div id="console-output" class="output" style="max-height: 300px; overflow-y: auto;"></div>
  </div>

  <script src="ai-insights.js"></script>
  <script>
    // Capture console logs
    const consoleDiv = document.getElementById('console-output');
    const originalLog = console.log;
    const originalError = console.error;
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      consoleDiv.innerHTML += `[LOG] ${args.join(' ')}\n`;
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      consoleDiv.innerHTML += `[ERROR] ${args.join(' ')}\n`;
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };

    // Test 1: Check if functions are loaded
    async function testFunctionsLoaded() {
      const output = document.getElementById('test1-output');
      output.className = 'output';
      
      const tests = {
        'checkGeminiNanoAvailability': typeof checkGeminiNanoAvailability,
        'generateAIInsights': typeof generateAIInsights,
        'initializeGeminiNano': typeof initializeGeminiNano,
        'createAnalysisPrompt': typeof createAnalysisPrompt,
        'sanitizeAIResponse': typeof sanitizeAIResponse,
        'generateEnhancedFallbackInsight': typeof generateEnhancedFallbackInsight
      };
      
      let allGood = true;
      let result = 'Function Availability Check:\n\n';
      
      for (const [funcName, funcType] of Object.entries(tests)) {
        const status = funcType === 'function' ? '✅ Available' : '❌ Missing';
        result += `${funcName}: ${status} (${funcType})\n`;
        if (funcType !== 'function') allGood = false;
      }
      
      output.textContent = result;
      output.className = allGood ? 'output success' : 'output error';
    }

    // Test 2: Check Gemini Nano availability
    async function testAvailability() {
      const output = document.getElementById('test2-output');
      output.className = 'output';
      output.textContent = 'Checking Gemini Nano availability...';
      
      try {
        const isAvailable = await checkGeminiNanoAvailability();
        
        let result = `Gemini Nano Available: ${isAvailable}\n\n`;
        
        // Check window.ai
        result += `window.ai exists: ${typeof window.ai !== 'undefined'}\n`;
        result += `window.ai.languageModel exists: ${typeof window.ai?.languageModel !== 'undefined'}\n`;
        
        if (typeof window.ai !== 'undefined' && typeof window.ai.languageModel !== 'undefined') {
          try {
            const capabilities = await window.ai.languageModel.capabilities();
            result += `\nCapabilities:\n${JSON.stringify(capabilities, null, 2)}`;
          } catch (e) {
            result += `\nError getting capabilities: ${e.message}`;
          }
        }
        
        output.textContent = result;
        output.className = isAvailable ? 'output success' : 'output';
      } catch (error) {
        output.textContent = `Error: ${error.message}\n${error.stack}`;
        output.className = 'output error';
      }
    }

    // Test 3: Generate test insight
    async function testInsightGeneration() {
      const output = document.getElementById('test3-output');
      output.className = 'output';
      output.textContent = 'Generating insight...';
      
      const testData = {
        work: { 'github.com': 1800, 'docs.google.com': 900 },
        unproductive: { 'twitter.com': 600, 'reddit.com': 300 },
        neutral: { 'gmail.com': 200 },
        totalWorkTime: 2700,
        totalUnproductiveTime: 900,
        totalNeutralTime: 200
      };
      
      try {
        const insight = await generateAIInsights(testData);
        output.textContent = `SUCCESS!\n\nGenerated Insight:\n\n${insight}`;
        output.className = 'output success';
      } catch (error) {
        output.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
        output.className = 'output error';
      }
    }

    // Test 4: Full integration test
    async function testFullIntegration() {
      const output = document.getElementById('test4-output');
      output.className = 'output';
      output.textContent = 'Running full integration test...\n\n';
      
      let log = '';
      
      try {
        // Step 1: Check functions
        log += '1. Checking functions... ';
        if (typeof generateAIInsights !== 'function') {
          throw new Error('generateAIInsights not found');
        }
        log += '✅\n';
        
        // Step 2: Check availability
        log += '2. Checking Gemini Nano... ';
        const isAvailable = await checkGeminiNanoAvailability();
        log += isAvailable ? '✅ Available\n' : '⚠️ Not available (will use fallback)\n';
        
        // Step 3: Test with empty data
        log += '3. Testing with empty data... ';
        const emptyInsight = await generateAIInsights({
          work: {}, unproductive: {}, neutral: {},
          totalWorkTime: 0, totalUnproductiveTime: 0, totalNeutralTime: 0
        });
        log += emptyInsight ? '✅\n' : '❌ Failed\n';
        
        // Step 4: Test with real data
        log += '4. Testing with sample data... ';
        const realInsight = await generateAIInsights({
          work: { 'github.com': 2700 },
          unproductive: { 'twitter.com': 900 },
          neutral: {},
          totalWorkTime: 2700,
          totalUnproductiveTime: 900,
          totalNeutralTime: 0
        });
        log += realInsight ? '✅\n' : '❌ Failed\n';
        
        log += '\n✅ ALL TESTS PASSED!\n\n';
        log += 'Sample Output:\n' + realInsight;
        
        output.textContent = log;
        output.className = 'output success';
        
      } catch (error) {
        log += `\n\n❌ TEST FAILED\n\nError: ${error.message}\n${error.stack}`;
        output.textContent = log;
        output.className = 'output error';
      }
    }
    
    // Auto-run basic test on load
    window.addEventListener('load', () => {
      console.log('Test page loaded');
      testFunctionsLoaded();
    });
  </script>
</body>
</html>
